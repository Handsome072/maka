name: Deploy to cPanel (Static Export)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Static Files to cPanel
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js (static export)
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prepare static files for deployment
        env:
          BACKEND_API_URL: ${{ secrets.BACKEND_API_URL || 'https://api.homiqio.com' }}
        run: |
          echo "Preparing static files for deployment..."

          # Verify out directory exists (created by next build with output: 'export')
          if [ ! -d "out" ]; then
            echo "Error: 'out' directory not found. Build may have failed."
            exit 1
          fi

          # Create .env file in out directory for reference
          echo "Creating .env file for server reference..."
          echo "NEXT_PUBLIC_API_URL=${BACKEND_API_URL:-https://api.homiqio.com}" > out/.env
          echo "NODE_ENV=production" >> out/.env
          echo "✓ Created .env file in out directory"
          echo ""
          echo ".env file contents:"
          cat out/.env

          # Copy .htaccess from public if it exists
          if [ -f "public/.htaccess" ]; then
            cp public/.htaccess out/.htaccess
            echo "Copied .htaccess to out directory"
          fi

          # Set proper permissions for all files
          chmod -R 755 out/
          find out -type f -exec chmod 644 {} \;
          echo "Set file permissions"

          # Final verification
          echo ""
          echo "=== Static build verification ==="
          echo "Total files to deploy:"
          find out -type f | wc -l
          echo ""
          echo "Build size:"
          du -sh out/
          echo ""
          echo "Key files:"
          ls -la out/ | head -20
          echo ""
          if [ -f "out/.htaccess" ]; then
            echo "✓ .htaccess file found"
          else
            echo "⚠ Warning: .htaccess file not found"
          fi
          if [ -f "out/.env" ]; then
            echo "✓ .env file found (deployed to server)"
          else
            echo "⚠ Warning: .env file not found"
          fi

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy static files to cPanel via lftp
        env:
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_SERVER }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          echo "Deploying static files via lftp..."
          lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" << EOF
          set ftp:ssl-allow no
          set net:timeout 60
          set net:max-retries 3
          mirror -R --verbose --delete ./out/ $REMOTE_DIR
          quit
          EOF
          echo "FTP upload complete"

      - name: Deployment complete
        run: |
          echo "✅ Static files deployment completed!"
          echo ""
          echo "The static files have been deployed to: ${{ secrets.REMOTE_DIR }}"
          echo ""
          echo "No Node.js server needed - files are served directly by Apache/cPanel"
          echo ""
          echo "To verify deployment:"
          echo "  1. Check your website URL"
          echo "  2. Verify .htaccess is working (check URL rewriting)"
          echo ""
          echo "If you need to check files on server:"
          echo "  cd ${{ secrets.REMOTE_DIR }}"
          echo "  ls -la"
          echo ""
          echo "Note: .env file with backend configuration has been deployed for reference"
          exit 0
