# ============================================
# Configuration Apache pour Next.js Static Export
# Déploiement sur o2switch/cPanel
# ============================================

# Activer le moteur de réécriture
RewriteEngine On

# ============================================
# FORCER HTTPS (Sécurité)
# ============================================
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# GESTION DES TRAILING SLASHES
# Next.js avec trailingSlash: true
# ============================================

# Si le fichier ou dossier existe, le servir directement
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Pour les routes sans extension et sans trailing slash, ajouter le slash
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_URI} !\.[^/]+$
RewriteRule ^(.*)$ /$1/ [L,R=301]

# Servir index.html pour les routes avec trailing slash
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1/index.html [L]

# ============================================
# OPTIMISATION DU CACHE
# ============================================
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Assets statiques Next.js (immutables - 1 an)
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  
  # HTML (pas de cache - vérifier à chaque fois)
  ExpiresByType text/html "access plus 0 seconds"
  
  # JSON (pas de cache)
  ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# ============================================
# COMPRESSION GZIP
# ============================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ============================================
# HEADERS DE SÉCURITÉ
# ============================================
<IfModule mod_headers.c>
  # Prévenir le MIME type sniffing
  Header set X-Content-Type-Options "nosniff"
  
  # Protection contre le clickjacking
  Header set X-Frame-Options "SAMEORIGIN"
  
  # Protection XSS
  Header set X-XSS-Protection "1; mode=block"
  
  # Référer Policy
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Cache immutable pour les assets Next.js (_next/static/)
  <FilesMatch "\.(js|css|woff|woff2|ttf|otf|eot|png|jpg|jpeg|gif|webp|svg|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  
  # Pas de cache pour HTML
  <FilesMatch "\.(html|htm)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
</IfModule>

# ============================================
# TYPES MIME (au cas où)
# ============================================
<IfModule mod_mime.c>
  AddType application/javascript js
  AddType text/css css
  AddType image/svg+xml svg
  AddType font/woff woff
  AddType font/woff2 woff2
  AddType application/font-woff woff
  AddType application/font-woff2 woff2
</IfModule>

# ============================================
# DÉSACTIVER L'INDEXATION DES RÉPERTOIRES
# ============================================
Options -Indexes

# ============================================
# PROTECTION DES FICHIERS SENSIBLES
# ============================================
<FilesMatch "^\.">
  Order allow,deny
  Deny from all
</FilesMatch>

# ============================================
# GESTION DES ERREURS PERSONNALISÉES (Optionnel)
# ============================================
# ErrorDocument 404 /404/index.html
# ErrorDocument 500 /500/index.html

